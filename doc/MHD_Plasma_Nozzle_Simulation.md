
https://aistudio.google.com/app/prompts?state=%7B%22ids%22:%5B%221pF6vPHp4vTapnBdEJGK2X9e4z7Qzpm_P%22%5D,%22action%22:%22open%22,%22userId%22:%22100958146796876347936%22,%22resourceKeys%22:%7B%7D%7D&usp=sharing

## USER:

I'm thinking about programing simulation of magnetohydrodynamics in cyclindrical coordinats. In particular I wanted to simulate two processes related to pulsed nuclear propulsion of spacecraft using magnetic confinement and magnetic nozzle. Key for efficient implementation is to assume that due to cylindrical symmetry this is basically 2D problem (radial and axial direction) while all properties are constant along angular coordinate (angle phi). Therefore it is only necessary to consider scaling by radius r when transforming between intensive and extensive variable (as volume of 2D cells should be multiplied by 2piR, the same with area, and force acting on boundaries between such cells). For simulation of magnetic fields at the beggining we can consider that all the coils are aligned with the axis, therefore they are projected to our 2D plane just as pair of points. In analogy to potenial flow thery we can consider these as two vortexes generating vorticity of the field. The total magnetic field in the simulation domain is weighted sum (superposition) of the coils. We assume fast processes, so that resistance of the plasma and the coils is negligible (currents are conserved), so we can assume Faraday law and Boit-Sawart law.

This mean that when diamagnetic plasma cloud expand in the magnetic field generated by the coils it will generate magnetic field preventing change of magnetic field in the test points. In fact ti will press the magnetic field agains the coductive cage (as the nozzle is made from conductors). And we can basically use just static system of linear equations where we search such linear combination of currents in the coils which match the expected value of magnetic field at control-points (for example we put control points need the nozzle metalic cage, and inside the plasma, inside the plasma the magnetization should vanish as the expanding plasma is initially diamagnetic, while near the metalic cage the initial pre-magnetization should be preserved). This is similar to potential-flow calculations such as vortex-lattice method in aerodynamics, where one search for vorticity on set of basis functions (typically placed inside the wing, e.g. at so called lift line) which should match condition of zero flow velocity perpendicular to surface of the wing (there are multiple "panels" with contorl points at the surface of the wing). In order to make the system well dertermined, resp. overdetermined, number of control points (i.e. condition) is higher than numbe of basis functions (i.e. number of coils in our case).

Now the practical realization of plasma nozzle is such that the the interior of the nozzle is made of conductive cage normal metal (tungsen, tantalum) at high temeprature (glowing hot, >1000K). Shielded behind this metalic cage at some offset distance (on the outer perimeter of the nozzle) are superconductive coils cooled to low temperature (liquid nitrogen). This shields the fragile cooled superconductor from radiation (mosly X-ray but also neutrons) from the nuclear explosion and the expanding plasma ball inside the nozzle. Due to limited critical currents in the superconductor, we need that after the explosion majority of current generating the confinement field is generated by electro-motoric induction inside the metalic cage and inside the outer shells of the expading plasma balls. Therefore we place our basis-functions into the azimutal coils of the cage, and inside zimutal coils sampling the surface of the plasma ball.

Since we are goig to work in cylindrical coordinates with axial coils we want to know analytical expression for magnetic field of coil (circular wire) at any point in space (not just along the axis which is easy). I remember that this leads to some eliptical integrals
Later we want to apply same solver to oposite system - magneto-interial compression, which is used for some magnto-intertial fusion propulsion systems where set of lithium liners (typically made of thin-cylindrical shels of rings of lithium) are accelerated by current and magnetic field and they impact of Lithium-Deuteride target.

Can you elaborate on this idea, check the validity and feasibility of such propulsion system, of the simulation, point out possible problems and chalanges, and expand technical details which can form comprehensive design document for numerical implementation of the solver?


---

This is a sophisticated concept that bridges the gap between **magnetohydrodynamics (MHD)** and **boundary element methods (BEM)**. You are essentially proposing a **filamentary (or discrete vortex) method** to solve the magnetic field evolution, coupled with a Lagrangian description of the plasma and structure.

Below is a comprehensive design document and feasibility analysis for your simulation.

### 1. Conceptual Validation & Physics Assessment

#### The "Potential Flow" Analogy (Green's Function Approach)
Your intuition to use a superposition of coils (filaments) rather than a volumetric grid (like FDTD or FEM) is mathematically valid for this regime. In electromagnetics, this is often called the **Method of Moments (MoM)** or a **Filamentary Network Method**.
*   **Validity:** This works well because you assume $R_m$ (Magnetic Reynolds Number) $\gg 1$. The magnetic field diffusion time is much longer than the pulse duration. Therefore, flux is "frozen" into the conductors.
*   **Correction on "Current Conservation":** You mentioned "currents are conserved." In a superconducting or fast-transient conductive loop, **Magnetic Flux ($\Phi$) is conserved**, not Current ($I$). As the geometry changes (plasma expands, changing Mutual Inductance $M$), the currents *must* change to keep $\Phi$ constant.
    *   Equation: $\Phi_i = L_i I_i + \sum_{j \neq i} M_{ij} I_j = \text{constant}$.
    *   Your linear solver will solve for the vector $\mathbf{I}$ at every time step given the new geometry ($M_{ij}$).

#### The Propulsion Concept (Flux Compression)
The separation of functions (Superconductor for bias field, Hot Tungsten Cage for transient containment) is a known and sound engineering principle, often used in **Flux Compression Generators**.
*   **Mechanism:** The superconductor creates an initial seed flux. The expanding plasma pushes this flux outward. Because the Tungsten cage is conductive and the timescale is short, the flux cannot penetrate the cage instantly. The field lines get "squashed" between the plasma and the cage, causing $B$ to spike.
*   **Benefit:** The magnetic pressure ($B^2/2\mu_0$) acts on the Tungsten cage (which can handle the stress and heat), shielding the fragile superconductor.

### 2. Mathematical Framework: Cylindrical Coords & Elliptic Integrals

You need the analytical solution for a current loop of radius $a$ carrying current $I$, at a point $(r, z)$. We assume the loop is centered at $(0, z')$ in cylindrical coordinates.

Let $\Delta z = z - z'$.
Let $R = \sqrt{r^2 + a^2 + \Delta z^2 + 2ra}$.
Let $m = \frac{4ra}{r^2 + a^2 + \Delta z^2 + 2ra}$.

The vector potential $A_\phi$ and magnetic field components involve **Complete Elliptic Integrals of the 1st kind $K(m)$ and 2nd kind $E(m)$**.

**The Vector Potential ($A_\phi$):**
$$ A_\phi = \frac{\mu_0 I}{\pi \sqrt{m}} \frac{\sqrt{r a}}{r} \left[ (1 - m/2) K(m) - E(m) \right] $$

**Radial Magnetic Field ($B_r = -\partial A_\phi / \partial z$):**
$$ B_r = \frac{\mu_0 I}{2\pi} \frac{\Delta z}{r \sqrt{(r+a)^2 + \Delta z^2}} \left[ -K(k^2) + \frac{r^2 + a^2 + \Delta z^2}{(r-a)^2 + \Delta z^2} E(k^2) \right] $$

**Axial Magnetic Field ($B_z = \frac{1}{r} \partial(r A_\phi) / \partial r$):**
$$ B_z = \frac{\mu_0 I}{2\pi} \frac{1}{\sqrt{(r+a)^2 + \Delta z^2}} \left[ K(k^2) + \frac{a^2 - r^2 - \Delta z^2}{(r-a)^2 + \Delta z^2} E(k^2) \right] $$

*Note: There are various conventions for the parameter $m$ or $k$ in elliptic integral libraries (e.g., Python's `scipy.special` uses $m=k^2$). Ensure you check the documentation of the library you use.*

### 3. Numerical Implementation Design

#### A. Discretization Model
Instead of a grid, you have **Agents/Lagrangian Elements**:
1.  **Fixed Agents (The Cage):** A set of rings at fixed $(r, z)$ coordinates. They have variable current $I_{cage}$.
2.  **Fixed Agents (The Superconductors):** A set of rings at fixed $(r, z)$ with fixed constant current $I_{SC}$ (assuming they are far enough away or regulated to be constant current sources).
3.  **Dynamic Agents (The Plasma Surface):** A "chain" of rings representing the plasma boundary. These move.

#### B. The Linear Solver (The "Matrix" Step)
At each time step $t$, the geometry is known. You need to find the currents in the Cage and Plasma.

**Method 1: Flux Conservation (More robust for rings)**
For every closed conductive loop $i$ (plasma surface rings and cage rings):
$$ \sum_{j} M_{ij}(t) I_j(t) + M_{i, SC} I_{SC} = \Phi_{i, initial} $$
*   $M_{ij}$ is the Mutual Inductance between loop $i$ and loop $j$ (derived from $A_\phi$ formulas above).
*   $M_{ii}$ is Self Inductance (requires a wire radius $r_w$ to avoid singularity: $L \approx \mu_0 a (\ln(8a/r_w) - 2)$).
*   This is a system $M \mathbf{I} = \mathbf{\Phi}$. Solve for $\mathbf{I}$.

**Method 2: Control Points (The "Aerodynamics" approach you suggested)**
If you model the cage not as loops but as specific points where $B_{\perp} = 0$:
1.  Define Control Points on the cage surface and plasma surface.
2.  Construct matrix $A$ where $A_{ij}$ is the magnetic field contribution of unit current $j$ at point $i$.
3.  Solve $A \mathbf{I} = \mathbf{B}_{boundary}$.
*   *Recommendation:* Use Method 1 (Flux) for the loops. It inherently conserves energy and physics better for high conductivity rings. Use Method 2 only if modeling complex non-loop geometries.

#### C. Dynamics (Time Stepping)
Once you have currents $\mathbf{I}$:
1.  **Calculate Forces:** Use Lorentz force $\mathbf{F} = \mathbf{I} \times \mathbf{B}$.
    *   Force on Plasma Ring $i$: $F_{r,i} = I_i \times (\sum B_z)$ and $F_{z,i} = I_i \times (\sum -B_r)$.
    *   *Note:* Do not include the field of the ring itself in the sum (self-force is internal pressure/hoop stress).
2.  **Update Position:** Use a symplectic integrator (like Verlet) to move the plasma rings based on $\mathbf{F}$ and plasma mass.
    *   $r(t+\Delta t) = r(t) + v_r \Delta t$
    *   *Scaling:* Remember the mass of a "ring" particle scales with $2\pi r$.
3.  **Remeshing (Crucial for Plasma):** As the plasma expands/implodes, rings may get too far apart or bunch up. You need an algorithm to add/merge rings to maintain resolution.

### 4. Specific Challenges & Solutions

#### 1. The Singularity Problem
The Biot-Savart law yields infinite $B$ exactly at the wire filament.
*   **Solution:** Assign a finite "core radius" to your plasma filaments and cage wires. When calculating $B$ at a distance $d < r_{core}$, use a linear falloff (solid body current) or simply cap the distance term.

#### 2. Extensive vs Intensive Scaling
As you noted, this is 2D, but it represents 3D.
*   **Volume/Mass:** A plasma element at radius $r$ represents a torus of volume $V_{2D} \cdot 2\pi r$.
*   **Pressure:** The magnetic pressure $P_{mag} = B^2 / 2\mu_0$ is intensive (independent of $r$).
*   **Force:** The total radial force on a ring is $F_r = 2\pi r \cdot (J_\phi \times B_z)$.

#### 3. Stability (The Physics Killer)
*   **Rayleigh-Taylor (RT):** In the Magneto-Inertial fusion case (Lithium liner imploding), the deceleration phase is unstable. Heavy fluid (Lithium) is being stopped by light fluid (Magnetic field).
    *   *Simulation Limit:* A 2D code **cannot** see $m \ge 1$ azimuthal instabilities. Your liner will look perfect in 2D, but in reality, it might break apart. You must add a perturbation analysis or "mix model" if you want to predict fusion yield realistic.
*   **Kink Instability:** Similarly, current carrying plasma columns are prone to kinking. This is also invisible in 2D axisymmetric code.

#### 4. The Cage Resistance
You assumed negligible resistance. For Tungsten at 2000K:
*   If the pulse is microseconds: Assumption holds.
*   If the pulse is milliseconds: Flux will leak through the cage.
*   *Implementation:* Add a resistance term to the flux conservation:
    $$ \frac{d\Phi}{dt} = -I R_{resistance} $$
    $$ \mathbf{M} \frac{d\mathbf{I}}{dt} + \frac{d\mathbf{M}}{dt}\mathbf{I} = -\mathbf{R}\mathbf{I} $$

### 5. Implementation Roadmap (Draft)

**Phase 1: The Static Solver**
*   Implement `calc_B_field(r_src, z_src, r_obs, z_obs, I)` using Elliptic Integrals.
*   Validate against known textbook formulas (e.g., field on axis of a solenoid).
*   Visualize the field lines of a simple Helmholtz coil configuration.

**Phase 2: The Flux Solver**
*   Define a `System` object containing a list of `Coils`.
*   Calculate the Mutual Inductance Matrix $\mathbf{M}$.
*   Solve $\mathbf{I} = \mathbf{M}^{-1} \mathbf{\Phi}$.
*   Test: Move a "passive" coil toward a "fixed current" coil and verify the induced current opposes the motion (Lenz's Law).

**Phase 3: Dynamics (The Launcher)**
*   Define Plasma as a list of points with mass.
*   Loop:
    1.  Calc Inductance Matrix based on positions.
    2.  Solve Currents to conserve Flux.
    3.  Calc B-field at every plasma point.
    4.  Calc Lorentz Force.
    5.  Update Velocity/Position.
*   *Output:* Plots of plasma shape vs time.

**Phase 4: Magneto-Inertial Fusion (The Implosion)**
*   Invert the logic: The outer coils pulse a massive current.
*   The "Liner" (Lithium) starts with zero flux inside.
*   The current in outer coils induces opposing current in the Liner.
*   Lorentz force implodes the Liner.

### Summary
Your approach is **highly feasible** for a rapid prototyping tool. It avoids the heavy computational cost of Grid-MHD. It is essentially a "Lagrangian Axisymmetric Magnetostatics" code.

**Key Recommendation:** Start with Python (`numpy`, `scipy.special`, `matplotlib`). The matrix inversion for $N < 1000$ filaments is instantaneous. If you need higher performance later, port the interaction loop (the $N^2$ part) to C++ or Numba.

---

## USER 2:

OK, I think your analysys is very good. I would like to discuss more few points you raised.

1) plasma instabilites like raighli-taylor I want to largely ignore now. I think these are relevant mainly for compression, but for expainsion not so much as the expanding cloud sooth them out (by streching the plasma sheet), whicich is opossite than wrinkeling duing compression (e.g. in laser fusin with intertial confinement). I imagine it a bit like skin, or rubber balloon filled by air. When you expand it is is smooth, when you deflate it, it start to be wrinkled.

2) I think I still prefer Method 2: Control Points (The "Aerodynamics" approach you suggested), but maybe I do not clearly undertant the differentces from Method 1: Flux Conservation (More robust for rings), what are the pros and cons in terms of stability, accuracy and most importaintly the performance and computational cost. Why one is used in aerodynamics and the other not, I feel like aerodynamics and magnetodynamics share a lot, so same method should be suitable for both.

3) I want to correct some technical details about placement of basis functions and control points in 
Method 2: Control Points (The "Aerodynamics" approach you suggested)

3a) the metalic cage should be itself generator of magnetic field, so we should put basis functions (coils) there, not control points. Control points should be placed slightly above the cage (in the space between the cage and the plasma). The coils in the cage should have zero current initially, but as the plasma expands it should induce current in them. Also the plasma is magnetic generator (resp. its outer shell), so we should put coils (current loops = vortex filaments = basis functions) into the outer shell of the plasma, and control points just above the plasma surface. In these control point between the inner surface of metalic cage and outer shell of plasma should be preserved initial magnetic flux (right?).

Now we should add aditiona control points behind the cage (on the side of superconductive coils), and also perhaps add some inside the plasma (under the outer plasma shell made of coils), these control point should also preserve the intial magnetic flux there (basically digamagnetic non-agnetized plasma deep inside, and initial field generated by superconductive coils - which also prevents the coils from reaching critical currents), Right?


3b) no remeshing. Remeshing is complicated operation. I would rather sacrifice maybe a bit of physical realism and add spring-like bonds between the current basis functions in the plasma shell. This will keep them in more or less reasonable distance (equdistant). Again this is somewhat in analogy to the gass-filled rubber balloon. Nevertheless, in oder to make this work I should also compute the preassure of the plasma inside the ballon exerting force on the outer "rubbery shell". I do not want to complex finite-element description of the inner plasma ball, I can just consider it to be homogenous ideal gas behaving according to ideal gas equation pV=nRT, which I think is fine for non-magnetic plasma.

---


This is a very coherent evolution of the design. You are effectively moving towards a **Lagrangian Meshless Method** (specifically a "Discrete Vortex Method" coupled with "Soft Body Dynamics").

This approach is computationally efficient and fits the physics of a "bouncing" plasma pulse very well.

Here is the detailed breakdown of your points, specifically focusing on the comparison of methods and the specific implementation of the "Balloon" model.

### 1. Stability & The "Balloon" Analogy
**You are correct.**
*   **Expansion (Propulsion):** The plasma is effectively the "heavy fluid" pushing against the "light fluid" (magnetic field). While technically Rayleigh-Taylor unstable, the expansion stretches the plasma surface (like an inflating balloon). This stretching increases the "k-number" of any perturbation, effectively damping it out or slowing its growth rate enough that it doesn't matter for the duration of the pulse.
*   **Compression (Fusion):** Here, the balloon is shrinking. The surface perimeter decreases, "bunching up" any irregularities. This amplifies instabilities.
*   **Conclusion:** For the propulsion phase, ignoring RT and using a spring-mesh is a perfectly valid engineering approximation.

### 2. Method 1 (Flux/Circuit) vs. Method 2 (Aerodynamic/Control Points)

You prefer Method 2. Let’s analyze why Aerodynamics uses it and whether it fits here.

**Why Aerodynamics uses Control Points (Vortex Lattice):**
In aerodynamics, the "wake" extends to infinity. Calculating the total "flux" (stream function) requires integrating to infinity or defining complex closed domains. It is mathematically much easier to say "Velocity normal to the wing surface is zero" at a specific point.

**Why Electromagnetics usually uses Flux (Method 1):**
In Magnetics with wire loops, the domain is closed and finite. The "Flux" is simply the integral of the field passing through the ring.
*   **The Physics:** Superconductors/perfect conductors conserve **Flux**, not localized B-field points.
*   **The Trap of Method 2:** If you place control points *between* your coils, magnetic field lines can "leak" through the gaps between the points, even if the math says the points are shielded.
*   **The Advantage of Method 1:** By calculating Flux through the loop, you effectively integrate the B-field over the entire area. It makes the barrier "watertight" regardless of how far apart your rings are.

**Verdict:**
You *can* use Method 2 (Control Points), but to make it stable, you must ensure your control points are **dense** (perhaps 2 points between every coil position) to prevent flux leakage.
*   *My Suggestion:* Stick to your preference for Method 2 (it is more intuitive to code: "Make B zero here"), but **place the control points `Collocated` with the basis functions**, not slightly offset.
    *   *Reason:* If you place a control point "slightly above" a current ring, you are solving an ill-conditioned matrix (singularities).

### 3. Technical Implementation: Placement of Basis & Control

Here is the corrected topology for your **Method 2 (Linear Solver)** setup.

We are solving for a vector of unknown currents $\mathbf{I}_{unknown}$.
$$ \mathbf{I}_{total} = [\mathbf{I}_{cage}, \mathbf{I}_{plasma}] $$

The Superconductor currents $\mathbf{I}_{SC}$ are **fixed constants** (Source terms).

#### A. The Condition for the Cage (Induction)
You want the Cage to act as a shield.
*   **Basis Function:** Current loops located at the physical wire positions of the Cage.
*   **Control Point:** Located **at the center** of each cage loop (Radius $r=0$ to $r_{cage}$).
*   **The Condition:** "The total Flux through this loop at time $t$ equals the total Flux at time $t=0$." (This is the discrete version of Faraday's law).
    *   $\sum M_{i,j} I_j + M_{i, SC} I_{SC} = \Phi_{initial}$

#### B. The Condition for the Plasma (Diamagnetism)
You want the plasma to exclude the field.
*   **Basis Function:** Current loops representing the *surface* of the plasma balloon.
*   **Control Point:** Located **just inside** the plasma surface (at $r_{surf} - \epsilon$).
*   **The Condition:** "The total B-field at this point is ZERO."
    *   $\sum \vec{B}_{i,j} I_j + \vec{B}_{i, SC} I_{SC} = 0$

**Refined Architecture:**
1.  **Fixed Sources:** Superconductive Coils (generate bias field).
2.  **Passive Conductors:** Cage Coils. Unknown $I_{cage}$. Equation: Flux Conservation.
3.  **Active Boundary:** Plasma Surface Coils. Unknown $I_{plasma}$. Equation: $B_{internal} = 0$.

*Note: Mixing "Flux Conservation" (Integral) equations and "Field Cancellation" (Differential) equations in one matrix is perfectly fine.*

### 4. The "Balloon" Physics Engine (No Remeshing)

This is the most critical part of your simulation. We treat the plasma as a **Soft Body Gas Bag**.

#### Step A: Geometry & Gas Physics
Assume your plasma is defined by $N$ nodes $(r_i, z_i)$ connected by segments.
1.  **Calculate Volume:** Use the Polygon Area formula (modified for cylindrical revolution volume):
    $$ V = \sum_{i=0}^{N-1} \pi (r_i + r_{i+1}) (r_i - r_{i+1}) (z_{i+1} - z_i) \text{ (approximation)} $$
    *Actually, correct Green's theorem form for Volume of revolution:*
    $$ V = -\pi \sum_{i=1}^{N} (z_{i+1} - z_i) (r_{i+1}^2 + r_i r_{i+1} + r_i^2) / 3 $$
2.  **Calculate Gas Pressure:**
    $$ P_{gas}(t) = P_{initial} \left( \frac{V_{initial}}{V(t)} \right)^\gamma $$
    (Where $\gamma = 5/3$ for monoatomic plasma).

#### Step B: Force Accumulation
For every node $i$ in the plasma shell, calculate three forces:

1.  **Gas Force (Expansion):**
    *   Normal vector to surface $\vec{n}$.
    *   Area of ring segment $A_i = 2\pi r_i \cdot L_{segment}$.
    *   $\vec{F}_{gas} = P_{gas} \cdot A_i \cdot \vec{n}$.
    *   *Direction:* Pushes OUT.

2.  **Magnetic Force (Compression/Confinement):**
    *   Calculate local $\vec{B}$ at the node location (sum of all other coils + SC + Cage).
    *   $\vec{F}_{mag} = I_i (\vec{L} \times \vec{B})$.
    *   In 2D Cylindrical:
        *   $F_r = I_i \cdot 2\pi r_i \cdot B_z$
        *   $F_z = I_i \cdot 2\pi r_i \cdot (-B_r)$
    *   *Direction:* Usually pushes IN.

3.  **Spring Force (Stability/Surface Tension):**
    *   Connect node $i$ to $i-1$ and $i+1$.
    *   $L_{current} = \text{distance}(i, i+1)$.
    *   $F_{spring} = k (L_{current} - L_{rest})$.
    *   *Direction:* Tangential (keeps nodes equidistant).

#### Step C: Time Integration
$$ \vec{a}_i = \frac{\vec{F}_{gas} + \vec{F}_{mag} + \vec{F}_{spring}}{m_i} $$
*   **Mass $m_i$:** Remember the mass of a node scales with radius! $m_i = \rho_{surface} \cdot 2\pi r_i$. If $r_i \to 0$ (axis), mass vanishes, which causes numerical explosion.
*   **Fix:** Assign a minimum mass or fix the nodes on the axis ($r=0$) to only move in $z$.

### Summary of the Solver Loop

1.  **Initialize:** Define SC coils, Cage geometry, and initial Plasma "Balloon" shape.
2.  **Time Loop:**
    3.  **Matrix Solve:**
        *   Build Matrix $A$:
            *   Rows 1..K (Cage): Mutual Inductance coefficients.
            *   Rows K..N (Plasma): B-field coefficients at control points just inside surface.
        *   Build Vector $b$:
            *   Cage: Initial Flux - Flux from SC coils.
            *   Plasma: -1 * B-field from SC coils.
        *   Solve $A \mathbf{x} = \mathbf{b}$ to get currents $I_{cage}$ and $I_{plasma}$.
    4.  **Physics Update:**
        *   Calculate Plasma Volume $V$ and Pressure $P$.
        *   Calculate Gas Forces, Magnetic Forces ($I \times B$), Spring Forces.
    5.  **Integrate:**
        *   Update velocities and positions (Verlet or Runge-Kutta).
    6.  **Visualization:** Plot $r$ vs $z$.

### Possible Pitfall: The "Zero Radius" Axis
When the plasma ball is closed on the axis (at $r=0$), your coordinate transformation (multiplying by $r$) goes to zero.
*   **Special handling:** The nodes at the very top and bottom of the balloon are technically on the axis ($r=0$).
*   They carry **Zero Current** (loop area is zero).
*   They experience **Zero Magnetic Force**.
*   They are moved purely by **Gas Pressure** (pushing in $z$) and **Springs** (pulling in $r$).
*   *Constraint:* Hard-code their $r$ coordinate to 0. Only allow $z$ motion.

This design is solid. It avoids the complexities of FEM/MHD while capturing the essential engineering physics of magnetic propulsion.


---

## USER 3

1) ad Baloon physics - what you proposed with volumes of polygons is kinda finite-volume or finite-element methods, which is prehaps good to implement in future, but now I want something simpler. I only want to consider homoganous ideal gass in some ball (spherical ball), and at constant intervals on surface of that ball put my coils. Aha I see if the mass-points on the surface (the coils) move independnetly, they can deviate the shape of plasma ball (deforming it) is it is no longer a sphere. OK, maybe we can use some more flexible shape (eliposide) which can deform to describe the plasma ball, but then we need to compute variational derivatives (forces) with respect to the eliposide parameters.  Is that easy? Maybe you are right it is easier to use finite volumes in shape of trinagles or quads (in 2D plane, i.e. rings in 3D), but this I would analyse deeper in next conversation.

2) Maybe you can go deeper into Method 1 (Flux/Circuit). 

Do I understand that taht method leads to some square-matrix, like gauss elemination / diagonalization, it is not fitting problem any more. ?

I have some intution that problem defined as "fitting" of right-hand-side are more numerically robust and stable, and they can be easily adjusted when things changes, and often it is easy to add some "regularization" which makes it more stable. Solving square matrix I often ended in situation which is numerically very sensitive to tiny details which may lead to physically unrealistic solutions. What I generally try to avoid is matrix diagonalization (eignevalue problems), as I sa it very numerically unstable, and also generally hader to implement (in C++, Javascript, OpenCL or GLSL shader which I plan to use). Any ideas on that? Maybe if you describe it in more detail, I will get more confortable with the method, or find the specific reasons why worry it may fail in practice.

---

You are asking exactly the right questions for someone planning to implement this on GPU (OpenCL/GLSL).

Here is the deep dive into the Shape mechanics and the Matrix stability, tailored for a robust, "shader-friendly" implementation.

---

### Part 1: The Shape - Why you should avoid the Ellipsoid

You suggested using an **Ellipsoid** to simplify the physics.
While mathematically elegant, calculating the forces on an ellipsoid in a non-uniform magnetic field is actually **harder** than the "Finite Element/Polygon" approach, and here is why:

1.  **The "Squeezing" Problem:** A nozzle works by squeezing plasma. An ellipsoid is defined by 2 radii ($R_r, R_z$). If the nozzle throat is narrower than the plasma, an ellipsoid cannot fit through physically—it would just bounce off. A real plasma (or a flexible polygon model) creates a "nose" to squeeze through the hole.
2.  **The Calculation:** To get the total force on an ellipsoid, you still have to integrate the magnetic pressure $B^2/2\mu_0$ over its surface. This means you still have to discretize the surface into points to do the integral.

**The "Simple" Solution: 1D Mass-Spring Chain**
Do not think of it as "Finite Element Method" (which implies complex basis functions). Think of it as a **Chain of Particles**.
*   You have an array `vec2 pos[N]`.
*   You have an array `float current[N]`.
*   **Physics:**
    1.  **Gas Pressure:** Every segment pushes its two neighbor vertices outward.
    2.  **Springs:** Every vertex pulls its neighbors closer.
    3.  **Magnetics:** Every vertex gets pushed by Lorentz force.

This is extremely easy to parallelize in a Compute Shader. Each thread handles one vertex. It naturally handles the "squeezing" through the nozzle without complex analytical derivatives.

### Part 2: Method 1 (Flux) vs. Method 2 (Fitting) - The Numerical Truth

You are absolutely correct in your intuition: **Fitting (Least Squares) is generally more robust than solving Square Matrices.**

Here is the technical breakdown:

#### Method 1: The "Square Matrix" (Flux Conservation)
You write one equation for every coil: "Flux now = Flux initial".
$$ [M] \cdot \vec{I} = \vec{\Phi}_0 $$
*   **The Matrix:** $M$ is the Mutual Inductance matrix ($N \times N$).
*   **The Problem:** If two coils get close to each other (e.g., in your plasma shell), their rows in the matrix become almost identical. The matrix becomes **Singular** (determinant $\to$ 0).
*   **The Result:** The solver blows up. You get currents like $+1,000,000$ A in one coil and $-999,999$ A in the neighbor. The physics is "correct" (the net field is finite), but numerically it is garbage and destroys your simulation.

#### Method 2: The "Fitting" (Field Cancellation)
You define $M$ control points (where $M \gg N$ coils). You want $B=0$ at these points.
$$ [A] \cdot \vec{I} \approx 0 $$
*   **The Solver:** You minimize the error $E = |A\vec{I}|^2$. This is solved via $A^T A \vec{I} = 0$ (conceptually).
*   **Why it is better for you:**
    1.  **Over-determined:** Noise averages out.
    2.  **Regularization (The "Secret Sauce"):** You can easily add a penalty for high currents!
        *   Minimize: $\text{Error} + \lambda \sum (I)^2$
        *   This prevents the "+1,000,000 / -1,000,000" explosion. The solver chooses the "smoothest" current distribution that satisfies the magnetic boundary conditions.


### Part 3: The "Shader-Friendly" Solver (No Diagonalization)

Since you want to use GLSL/OpenCL, **do not** try to implement Gaussian Elimination or Matrix Inversion. It is a nightmare on GPU.

Instead, use an **Iterative Solver** (Gradient Descent or Conjugate Gradient). This turns the "Matrix Problem" into a physical "Relaxation" process.

#### The Algorithm (The "Virtual Physics" approach)

Imagine the **Currents** themselves are physical variables that want to minimize the magnetic error.

**1. Setup (Per Frame):**
*   **Plasma Coils:** Variable currents $I_{plasma}$.
*   **Cage Coils:** Variable currents $I_{cage}$.
*   **Superconductors:** Fixed currents $I_{SC}$.
*   **Control Points:** Placed just inside the plasma surface and just outside the cage. Target Field $B_{target} = 0$ (or preserved initial field).

**2. The Solver Loop (Run this for e.g., 20 iterations per time-step):**
*   **Step A:** Calculate B-field at all control points.
    *   `B_error = B_calculated - B_target`
*   **Step B:** Calculate the "Gradient" (how much changing a current helps reduce the error).
    *   For each coil $j$:
        $$ \Delta I_j = - \alpha \sum_{points \ i} (\vec{B}_{error, i} \cdot \vec{B}_{unit\_current\_j, i}) $$
        *(Where $\alpha$ is a learning rate)*
*   **Step C:** Apply Regularization (Decay).
    *   $I_j = I_j \cdot (1.0 - \epsilon)$
    *   *(This mimics resistance and prevents numerical explosions)*

**Why this is perfect for you:**
1.  **No Matrix Inversion:** It's just vector dot-products.
2.  **Parallel:** Every coil can be updated in parallel.
3.  **Temporal Coherence:** The solution for frame $T$ is almost exactly the solution for frame $T-1$. You don't start from scratch; you just "nudge" the currents to the new solution.
4.  **Stability:** It never divides by zero. If the system is ill-conditioned, it just converges slowly, it doesn't crash.

### Summary of the Design Document Update

1.  **Plasma Model:** Use **Segmented Rings (Mass-Spring)**. It is computationally simpler ($O(N)$ vs complex integrals) and physically handles the nozzle "squeeze" correctly.
2.  **Electromagnetics:** Use **Method 2 (Control Points/Fitting)**.
    *   Place control points **collocated** with the coils (or slightly offset normal to surface).
    *   Add **Regularization** (penalty for total current squared) to ensure stability.
3.  **Implementation:** Use an **Iterative Gradient Descent Solver** for the currents.
    *   Treat Current $I$ as a dynamic variable just like Position $P$.
    *   Update $I$ to minimize Magnetic Error.
    *   Update $P$ to respond to Magnetic Force.

This approach is extremely robust, "GPU-native," and avoids all complex linear algebra libraries.